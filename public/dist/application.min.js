"use strict";var ApplicationConfiguration=function(){var applicationModuleName="syncloud",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","restangular"],registerModule=function(moduleName){angular.module(moduleName,[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),Events={LOADER_SHOW:"loader_show",LOADER_HIDE:"loader_hide"},ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("events"),ApplicationConfiguration.registerModule("metrics"),ApplicationConfiguration.registerModule("projects"),ApplicationConfiguration.registerModule("users"),ApplicationConfiguration.registerModule("usersettings"),angular.module("core").config(["$stateProvider","$urlRouterProvider","RestangularProvider",function($stateProvider,$urlRouterProvider,RestangularProvider){RestangularProvider.setBaseUrl("/api"),$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus",function($scope,Authentication,Menus){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1}),$scope.toggleCollapsibleMenu=function(){console.log("toggleCollapsibleMenu in HeaderController"),angular.element(window).width()<=992?(angular.element(".row-offcanvas").toggleClass("active"),angular.element(".left-side").removeClass("collapse-left"),angular.element(".right-side").removeClass("strech"),angular.element(".row-offcanvas").toggleClass("relative")):(angular.element(".left-side").toggleClass("collapse-left"),angular.element(".right-side").toggleClass("strech"))}}]),angular.module("core").controller("HomeController",["$scope","$location","Authentication",function($scope,$location,Authentication){$scope.authentication=Authentication,Authentication.user||$location.path("/signin"),console.log("/home ","$scope.authentication",$scope.authentication)}]);var _=window._,AlgoliaSearch=window.AlgoliaSearch,CodeMirror=window.CodeMirror;angular.module("core").directive("at",function(){return console.log("load AT directive"),{restrict:"A",require:"ngModel",controller:["$scope","$q","Authentication","Menus",function($scope,$q,Authentication){$scope.authentication=Authentication;var algolia=new AlgoliaSearch("L5WT7X7KKP","09ec46f6119c8ad16dbe6969c6f8f07f"),index=algolia.initIndex("test"),previousPosition=0;$scope.search=function(){for(var deferred=$q.defer(),startPosition=document.activeElement.selectionStart,aKeyWord="",found=!1,i=startPosition-1;i>=0;i--){var text=document.activeElement.value,subText=text.substring(i,startPosition);subText.indexOf("@")>=0&&!found&&(found=!0,aKeyWord=subText)}return previousPosition=document.activeElement.selectionEnd,index.search(aKeyWord,function(success,content){var data=_.map(content.hits,function(hit){return hit.template=hit.value?hit.action+':"'+hit.value+'"':hit.action,hit});deferred.resolve({data:data,keyword:aKeyWord})}),deferred.promise},$scope.makeSearch=function(keyword){var deferred=$q.defer();return index.search(keyword,function(success,content){var data=_.map(content.hits,function(hit){return hit.template=hit.value?hit.action+':"'+hit.value+'"':hit.action,hit});deferred.resolve({data:data,keyword:keyword})}),deferred.promise}}],link:function(scope,element,attrs){var isFilter="filter"===attrs.atTpl,template=isFilter?'<%=action %>  ==  "<%=value%>"':'<%=action %>:"<%=value%>"',editor=CodeMirror.fromTextArea(document.getElementById(attrs.id),{lineNumbers:!0,styleActiveLine:!0,matchBrackets:!0,theme:"monokai",mode:"javascript"});editor.on("inputRead",function(cm){for(var WORD=/[\w$]+/,word=WORD,cur=editor.getCursor(),curLine=editor.getLine(cur.line),start=cur.ch,end=start;end<curLine.length&&word.test(curLine.charAt(end));)++end;for(;start&&word.test(curLine.charAt(start-1));)--start;var curWord=start!==end&&curLine.slice(start,end);scope.makeSearch(curWord).then(function(result){var data=result.data;isFilter||data.push({displayText:"evolution",text:"evolution ( some_action:'some_value' ) ",className:"method"}),_.each(data,function(element){if(element.displayText=element.displayText||element.field,!element.text){var compiled=_.template(template),text=compiled(element);element.text=text}}),CodeMirror.showHint(cm,CodeMirror.hint.algolia,{completeSingle:!1,list:data})})})}}}),angular.module("core").directive("loader",function(){return{restrict:"A",templateUrl:"modules/core/directives/loader.client.view.html",controller:["$rootScope","$scope","Authentication","Menus",function($rootScope,$scope,Authentication){$scope.authentication=Authentication,$rootScope.$on("loader_show",function(){console.log("show"),$scope.showLoader=!0}),$rootScope.$on("loader_hide",function(){console.log("hide"),$scope.showLoader=!1})}],link:function(scope){scope.showLoader=!1}}}),angular.module("core").directive("sidemenu",function(){return{restrict:"A",templateUrl:"modules/core/directives/sidemenu.client.view.html",controller:["$scope","Authentication","Menus",function($scope,Authentication){$scope.authentication=Authentication}],link:function(scope){console.log("sidemenu directive"),scope.$on("toggleCollapsibleMenu",function(){angular.element(".left-side").toggleClass("collapse-left"),angular.element(".right-side").toggleClass("strech")})}}}),angular.module("core").service("Menus",[function(){this.defaultRoles=["user"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemType,menuItemUIRoute,isPublic,roles){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:isPublic||this.menus[menuId].isPublic,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:isPublic||this.menus[menuId].isPublic,roles:roles||this.defaultRoles,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}]),angular.module("events").config(["$stateProvider",function($stateProvider){$stateProvider.state("listOfEvents",{url:"/projects/:projectId/events/:identity",templateUrl:"modules/events/views/list-events.client.view.html"})}]);var _=window._,dc=window.dc,d3=window.d3,crossfilter=window.crossfilter,dagreD3=window.dagreD3,Events=window.Events,PUBNUB=window.PUBNUB;angular.module("events").controller("EventsController",["$scope","$rootScope","$stateParams","$location","Authentication","UsersettingService","ProjectService","EventService",function($scope,$rootScope,$stateParams,$location,Authentication,UsersettingService,ProjectService,EventService){$scope.timePath=function(sessions){var time1=new Date(sessions[0].date),time2=new Date(sessions[sessions.length-1].date);return Math.abs(time1.secondsSince(time2))},$scope.getTimeAverage=function(){var sum=0;return _.forEach($scope.tableEvents,function(session){sum+=$scope.timePath(session)}),sum/Object.keys($scope.tableEvents).length},$scope.getListOfEvents=function(){$rootScope.$broadcast(Events.LOADER_SHOW),ProjectService.getProject($stateParams.projectId).then(function(project){$scope.project=project,$scope.identity=$stateParams.identity.toLowerCase(),EventService.getEvents($scope.identity).then(function(events){$scope.events=events,$scope.settings=events[0].settings,$scope.tableEvents=EventService.getSessions(events),$scope.timeAverage=$scope.getTimeAverage(),$rootScope.$broadcast(Events.LOADER_HIDE)})})},$scope.getColor=function(index){var COLORS=["","green","red","purple"],colorSize=COLORS.length;return COLORS[index%colorSize]},$scope.sendURL=function(){var pubnub=PUBNUB.init({publish_key:"pub-c-ddc60605-57f5-4267-b32a-93af942c9438",subscribe_key:"sub-c-e66141da-5a29-11e4-bd8e-02ee2ddab7fe"}),url="https://www.hipchat.com/gDdXAMpiV?anonymous=1&timezone=Paris%2C+Madrid&minimal=1&welcome_msg=Questions%3F+Come+chat+with+us!+We%27re+here%2C+send+us+a+message";pubnub.publish({channel:"ninou-chat",message:url,callback:function(e){if(console.log("SUCCESS!",e),document.getElementById("liveChat")||document.getElementById("barOfChat"))document.getElementById("barOfChat").style.display="",document.getElementById("liveChat").style.display="",document.getElementById("ChatBlackBox").style.display="none";else{var div=document.createElement("div");div.id="ChatBlackBox",div.setAttribute("style","width:300px;background-color:black;height:40px;position: fixed; bottom:0;cursor:pointer;border-radius: 8px 8px 0 0;margin-left:1050px;"),div.setAttribute("onclick","document.getElementById('barOfChat').style.display='';document.getElementById('liveChat').style.display='';document.getElementById('ChatBlackBox').style.display='none';"),div.style.display="none";var div2=document.createElement("div");div2.setAttribute("style","color:white;margin-left:20px;margin-top:10px;font-size:20px;"),div2.innerHTML="click to display chat",div.appendChild(div2),document.body.appendChild(div);var chat=document.createElement("div");chat.id="liveChat",chat.setAttribute("style","box-shadow: 0px 0px 10px #888888;position: fixed; bottom:0;border:1px solid black;margin-left:1050px;margin-bottom:-3px;");var iframe=document.createElement("iframe");iframe.id="frameOfChat",iframe.src=url,iframe.height="300",iframe.setAttribute("style","border:none"),chat.appendChild(iframe),document.body.appendChild(chat);var bar=document.createElement("div");bar.id="barOfChat",bar.innerHTML="<div style='margin-top:10px;margin-left:10px;'>Welcome to Usertrack Chat</div>",bar.setAttribute("style","box-shadow: 0px 0px 10px #888888;width:302.5px;background-color:black;height:40px;position: fixed; bottom:303px;margin-left:1050px;color:white;");var reduceButton=document.createElement("a");reduceButton.setAttribute("style","color:white;font-size:60px;cursor:pointer;"),reduceButton.innerHTML="<div style='margin-top:-50px;margin-left:275px;'>-</div>",reduceButton.setAttribute("onclick","document.getElementById('barOfChat').style.display='none';document.getElementById('liveChat').style.display='none';document.getElementById('ChatBlackBox').style.display='';"),bar.appendChild(reduceButton),document.body.appendChild(bar)}},error:function(e){console.log("FAILED! RETRY PUBLISH!",e)}})}}]);var _=window._,dc=window.dc,d3=window.d3,crossfilter=window.crossfilter,dagreD3=window.dagreD3;angular.module("events").directive("timelineofevents",function(){return{restrict:"A",require:"ngModel",templateUrl:"modules/events/directives/timelineOfEvents.client.view.html",controller:["$scope","Authentication","Menus",function($scope,Authentication){$scope.authentication=Authentication}],link:function(scope,element,attrs,ngModel){console.log("timelineofevents directive"),scope.bgColor=attrs.color,ngModel.$render=function(){scope.tableOfEvents=ngModel.$viewValue}}}}).directive("eventsgraph",function(){return{restrict:"A",require:"ngModel",templateUrl:"modules/events/directives/eventsgraph.client.view.html",controller:["$scope","Authentication","Menus",function($scope,Authentication){$scope.authentication=Authentication,$scope.S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},$scope.uuid=function(){return $scope.S4()+$scope.S4()+$scope.S4()+$scope.S4()+$scope.S4()+$scope.S4()+$scope.S4()+$scope.S4()}}],link:function(scope,element,attrs,ngModel){console.log("timelineofevents directive"),scope.bgColor=attrs.color;var time1,time2;scope._id=scope.uuid(),ngModel.$render=function(){var events=ngModel.$viewValue;scope.events=_.sortBy(events,function(event){return event.date});var workers={};_.each(scope.events,function(event,index){var aDate=Date.create(event.date).format("{yyyy}-{MM}-{dd} {hh}:{mm}:{ss}");if(0===index){var key=event.key+":"+event.value;workers[key]={consumers:1,date:aDate,inputThroughput:0}}else{var previousEvent=scope.events[index-1];time1=new Date(event.date),time2=new Date(previousEvent.date);var deltaTime=Math.abs(time1.secondsSince(time2)),currentkey=event.key+":"+event.value,prevKey=previousEvent.key+":"+previousEvent.value;workers[currentkey]={consumers:1,date:aDate,inputQueue:prevKey,inputThroughput:deltaTime}}}),window.setTimeout(function(){scope.drawGraph(workers)},1e3)},scope.draw=function(isUpdate,workers){function transition(selection){return selection.transition().duration(500)}var zoom=d3.behavior.zoom(),nodes=[],edges=[];for(var id in workers){var worker=workers[id],className="";className+=worker.consumers?"running":"stopped",worker.count>1e4&&(className+=" warn");var html="<div>";if(html+='<span class="status"></span>',html+='<span class="name">'+id+"</span>",html+='<span class="queue"><span class="counter">'+worker.date+"</span></span>",html+="</div>",nodes.push({id:id,value:{label:html,className:className}}),worker.inputQueue){var label=worker.inputThroughput+"/s";edges.push({u:worker.inputQueue,v:id,value:{label:"<span>"+label+"</span>"}})}}var renderer=new dagreD3.Renderer,svg=d3.select("[id='"+scope._id+"']");console.log("SVG ==>",svg);var oldDrawNodes=renderer.drawNodes();renderer.drawNodes(function(graph,root){var svgNodes=oldDrawNodes(graph,root);return svgNodes.attr("id",function(u){return"node-"+u}),svgNodes.attr("class",function(u){return"node "+graph.node(u).className}),svgNodes}),renderer.transition(transition),renderer.zoom(function(graph,svg){return zoom.on("zoom",function(){svg.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")})});var layout=dagreD3.layout().nodeSep(70).rankSep(120).rankDir("LR"),renderedLayout=renderer.layout(layout).run(dagreD3.json.decode(nodes,edges),d3.select("[id='"+scope._id+"']").select("g")),zoomScale=zoom.scale(),graphWidth=renderedLayout.graph().width+80,graphHeight=renderedLayout.graph().height+20,width=parseInt(svg.style("width").replace(/px/,"")),height=parseInt(svg.style("height").replace(/px/,""));zoomScale=Math.min(width/graphWidth,height/graphHeight);var translate=[width/2-graphWidth*zoomScale/2,height/2-graphHeight*zoomScale/2];zoom.translate(translate),zoom.scale(zoomScale),svg.transition().duration(500)},scope.drawGraph=function(workers){scope.draw(!1,workers)}}}});var _=window._,dc=window.dc,d3=window.d3,crossfilter=window.crossfilter,dagreD3=window.dagreD3;angular.module("events").service("EventService",["Restangular",function(Restangular){var sessionDuration=15;return{getEvents:function(identity){return Restangular.one("events",identity).get()},getSessions:function(events){var sortedEvents=_.sortBy(events,function(event){return event.date}),deltaDateEvents=_.map(sortedEvents,function(event,index){if(0===index)event.deltaDate=0;else{{var previousEvent=sortedEvents[index-1];new Date(event.date).getTime()-new Date(previousEvent.date).getTime()}event.deltaDate=Date.create(event.date).minutesSince(Date.create(previousEvent.date))}return event}),sessionNumber=0,sessionNumberEvents=_.each(deltaDateEvents,function(event){event.deltaDate>=sessionDuration&&sessionNumber++,event.sessionNumber=sessionNumber}),sessions=_.groupBy(sessionNumberEvents,function(event){return event.sessionNumber});return sessions}}}]),angular.module("metrics").config(["$stateProvider",function($stateProvider){$stateProvider.state("listMetrics",{url:"/projects/:projectkey/metrics",templateUrl:"modules/metrics/views/list-metrics.client.view.html"}).state("createMetric",{url:"/projects/:projectkey/metrics/create",templateUrl:"modules/metrics/views/create-metric.client.view.html"})}]);var PUBNUB=window.PUBNUB,Events=window.Events;angular.module("metrics").controller("MetricsController",["$scope","$rootScope","$stateParams","$location","Authentication","MetricService","UsersettingService","ProjectService",function($scope,$rootScope,$stateParams,$location,Authentication,MetricService,UsersettingService,ProjectService){$scope.authentication=Authentication;var pubnub=PUBNUB.init({publish_key:"pub-c-ddc60605-57f5-4267-b32a-93af942c9438",subscribe_key:"sub-c-e66141da-5a29-11e4-bd8e-02ee2ddab7fe"});$scope.autocomplete=function(){ProjectService.getProject($stateParams.projectkey).then(function(project){$scope.project=project,UsersettingService.getUserSettingsKey($scope.project.key).then(function(userkeys){$scope.filters=$scope.select=$scope.charts=$scope.KeysUs=UsersettingService.mergeKey(userkeys)})})},$scope.create=function(){var metric={title:this.title,projectkey:$stateParams.projectkey,selects:this.select,filters:this.filters,aggregations:this.charts};MetricService.saveMetric(metric,$stateParams.projectkey).then(function(){$location.path("projects/metrics")})},$scope.update=function(){var metric=$scope.metric;MetricService.updateMetric(metric).then(function(){$location.path("projects/metrics")})},$scope.find=function(){$rootScope.$broadcast(Events.LOADER_SHOW),$scope.projectId=$stateParams.projectkey,MetricService.getMetrics($stateParams.projectkey).then(function(metrics){$scope.metrics=metrics,$rootScope.$broadcast(Events.LOADER_HIDE)})},$scope.analyse=function(KeysUs,select,filters,charts){select===KeysUs&&(select=""),filters===KeysUs&&(filters=""),charts===KeysUs&&(charts="");var aggregation=encodeURIComponent(charts).replace(/'/g,"%27").replace(/"/g,"%22"),aFilters=encodeURIComponent(filters).replace(/'/g,"%27").replace(/"/g,"%22"),data={select:select,filters:aFilters,charts:aggregation,KeysUs:KeysUs},projectkey=$stateParams.projectkey;MetricService.analyse(data,projectkey).then(function(response){var jobId=response.result.jobId;console.log("jobId",jobId),pubnub.subscribe({channel:jobId,callback:function(){console.log("message subscribe jobId",jobId),$scope.getResultJob(jobId)}})})},$scope.getResultJob=function(jobId){var projectkey=$stateParams.projectkey;MetricService.getResultJob(jobId,projectkey).then(function(response){var results=JSON.parse(response.result);console.log("results",results),$scope.results=results})}}]),angular.module("metrics").service("MetricService",["Restangular",function(Restangular){return{getMetrics:function(projectkey){return Restangular.all("projects/"+projectkey+"/metrics").getList()},saveMetric:function(metric,projectkey){return Restangular.all("projects/"+projectkey+"/metrics").post(metric)},analyse:function(metric,projectkey){return Restangular.all("projects/"+projectkey+"/analysis").post(metric)},getResultJob:function(jobId,projectkey){return Restangular.one("projects/"+projectkey+"/job",jobId).get()}}}]),angular.module("projects").config(["$stateProvider",function($stateProvider){$stateProvider.state("listProjects",{url:"/projects",templateUrl:"modules/projects/views/list-projects.client.view.html"}).state("createProject",{url:"/projects/create",templateUrl:"modules/projects/views/create-project.client.view.html"}).state("Project",{url:"/:projectId/page",templateUrl:"modules/projects/views/project-page.client.view.html"}).state("editProject",{url:"/projects/:projectId/edit",templateUrl:"modules/projects/views/edit-project.client.view.html"})}]);var Events=window.Events;angular.module("projects").controller("ProjectsController",["$scope","$rootScope","$stateParams","$location","Authentication","ProjectService",function($scope,$rootScope,$stateParams,$location,Authentication,ProjectService){$scope.authentication=Authentication,$scope.projectId=$stateParams.projectId,$scope.create=function(){var project={title:this.title,website:this.website,key:this.key};ProjectService.saveProject(project).then(function(){$location.path("projects")})},$scope.update=function(){var project=$scope.project;ProjectService.updateProject(project).then(function(){$location.path("projects")})},$scope.find=function(){$rootScope.$broadcast(Events.LOADER_SHOW),ProjectService.getProjects().then(function(projects){$scope.projects=projects,$rootScope.$broadcast(Events.LOADER_HIDE)})},$scope.findOne=function(){ProjectService.getProject($stateParams.projectId).then(function(project){$scope.project=project})},$scope.edit=function(project){$location.path("/projects/"+project._id+"/edit")},$scope.getColor=function(index){console.log("getColor");var COLORS=["#7761a7","#19b698","#3d566d","#ea6153","#001f3f","#f012be"],colorSize=COLORS.length;return COLORS[index%colorSize]}}]),angular.module("projects").directive("projectbox",function(){return{restrict:"A",require:"ngModel",templateUrl:"modules/projects/directives/projectbox.client.view.html",controller:["$scope","Authentication","Menus",function($scope,Authentication){$scope.authentication=Authentication}],link:function(scope,element,attrs,ngModel){console.log("projectBox directive"),scope.bgColor=attrs.color,ngModel.$render=function(){scope.project=ngModel.$viewValue}}}}),angular.module("projects").service("ProjectService",["Restangular",function(Restangular){return{getProjects:function(){return Restangular.all("projects").getList()},getProject:function(projectId){return Restangular.one("projects",projectId).get()},saveProject:function(project){return Restangular.all("projects").post(project)},updateProject:function(project){return Restangular.one("projects").customPUT(project,project._id)}}}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/signin.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function($scope,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.signup=function(){$http.post("/auth/signup",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})},$scope.signin=function(){$http.post("/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http.delete("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response},function(response){$scope.error=response.data.message})},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]),angular.module("usersettings").config(["$stateProvider",function($stateProvider){$stateProvider.state("listUsersettings",{url:"/projects/:projectId/us",templateUrl:"modules/usersettings/views/list-usersettings.client.view.html"})}]);var _=window._,dc=window.dc,d3=window.d3,crossfilter=window.crossfilter,dagreD3=window.dagreD3,Events=window.Events;angular.module("usersettings").controller("UsersettingsController",["$scope","$rootScope","$stateParams","$location","Authentication","UsersettingService","ProjectService",function($scope,$rootScope,$stateParams,$location,Authentication,UsersettingService,ProjectService){$scope.draw=function(data,keys){var yearRingChart=dc.pieChart("#chart-ring-year"),spendHistChart=dc.barChart("#chart-hist-spend"),spenderRowChart=dc.rowChart("#chart-row-spenders"),spendData=data,firstKey=keys[0],secondKey=keys[1],thirdKey=keys[2];spendData.forEach(function(d){d.Spent=d[thirdKey].match(/\d+/)});var ndx=crossfilter(spendData),firstDim=ndx.dimension(function(d){return d[firstKey]}),metricDim=ndx.dimension(function(d){return Math.floor(d[thirdKey])}),secondDim=ndx.dimension(function(d){return d[secondKey]}),spendPerYear=firstDim.group().reduceSum(function(d){return+d[thirdKey]}),spendPerName=secondDim.group().reduceSum(function(d){return+d[thirdKey]}),spendHist=metricDim.group().reduceCount();yearRingChart.width(200).height(200).dimension(firstDim).group(spendPerYear).innerRadius(10),spendHistChart.width(300).height(200).dimension(metricDim).group(spendHist).x(d3.scale.linear().domain([0,20])).elasticY(!0),spendHistChart.xAxis().tickFormat(function(d){return d}),spendHistChart.yAxis().ticks(2),spenderRowChart.width(350).height(200).dimension(secondDim).group(spendPerName).elasticX(!0),dc.renderAll()},$scope.find=function(){$rootScope.$broadcast(Events.LOADER_SHOW),ProjectService.getProject($stateParams.projectId).then(function(project){$scope.project=project,UsersettingService.getUserSettings(project.key).then(function(usersettings){var service=UsersettingService,tableOfKeysUS=[];$scope.usersettings=_.where(usersettings,{projectkey:$scope.project.key}),service.getUserSettingsKey($scope.project.key).then(function(userkeys){console.log(userkeys),$scope.KeysUs=service.mergeKey(userkeys),$scope.keysintextarea="",_.forEach($scope.KeysUs,function(key){$scope.keysintextarea=$scope.keysintextarea+"@"+key+" ",tableOfKeysUS.push(key)}),$scope.keysintextarea2=$scope.keysintextarea}),$scope.tableOfKeysUS=tableOfKeysUS,$scope.numberOfUsersettings=0===usersettings.length,$scope.KeyOfThisProject=project.key,$scope.projectId=$stateParams.projectId,$rootScope.$broadcast(Events.LOADER_HIDE)})})},$scope.extractkeysUS=function(keysInString,tableOfKeysUS){var expReg=/@(\w*?)(?: |$)/gi,resultat=keysInString.match(expReg);return resultat=_.map(resultat,function(keys){return keys.slice(1)}),resultat=_.map(resultat,function(keys){return keys.trim()}),_.intersection(resultat,tableOfKeysUS)},$scope.gotoEvents=function(usersetting){$location.path("/projects/"+$stateParams.projectId+"/events/"+usersetting.identity)}}]);var _=window._;angular.module("usersettings").service("UsersettingService",["Restangular",function(Restangular){return{getUserSettings:function(projectKey){return console.log("getUserSettings"),Restangular.one("projects",projectKey).all("usersettings").getList()},getUserSettingsKey:function(projectkey){return Restangular.one("userkeys",projectkey).get()},getkeysOfObject:function(obj){return Object.keys(obj)},notExisteInTwoTables:function(table1,table2,element){return this.existeInTables(table1,element)===!1&&this.existeInTables(table2,element)===!1},existeInTables:function(table,element){return-1!==_.indexOf(table,element)},mergeKey:function(table){var b={};return _.forEach(table,function(a){b=_.union(b,a.keys)}),b},convertStringOfUserKeysInTable:function(keystring){keystring=keystring.replace(/@/gi,"");var tableOfUserKeys=[],tmp="";_.forEach(keystring,function(z){" "===z?(tableOfUserKeys.push(tmp),tmp=""):tmp+=z})},delleteElementInTabelByIndex:function(table,index){table.splice(index,1)}}}]);